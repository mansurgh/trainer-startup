# ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ê–∫–∫–∞—É–Ω—Ç–æ–≤ ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ó–∞–≤–µ—Ä—à–µ–Ω–∞

## üõ°Ô∏è –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Supabase)
**–§–∞–π–ª:** `supabase_security_final.sql`

- ‚úÖ **RLS –≤–∫–ª—é—á—ë–Ω** –Ω–∞ –í–°–ï–• 7 —Ç–∞–±–ª–∏—Ü–∞—Ö:
  - `profiles` 
  - `workout_sessions`
  - `exercise_logs`
  - `nutrition_logs`
  - `body_measurements`
  - `chat_messages`
  - `progress_photos`

- ‚úÖ **28 –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** (4 –Ω–∞ –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É):
  - `*_select_own` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
  - `*_insert_own` ‚Äî –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏
  - `*_update_own` ‚Äî –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
  - `*_delete_own` ‚Äî –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏

- ‚úÖ **–¢—Ä–∏–≥–≥–µ—Ä `handle_new_user()`**:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  - `SECURITY DEFINER` –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
  - `ON CONFLICT DO NOTHING` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - 7-–¥–Ω–µ–≤–Ω—ã–π —Ç—Ä–∏–∞–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### 2. Flutter AuthService (lib/services/auth_service.dart)
- ‚úÖ **Singleton –ø–∞—Ç—Ç–µ—Ä–Ω** ‚Äî –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å –Ω–∞ –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- ‚úÖ **–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏** (`AuthException`):
  - `invalidEmail`, `weakPassword`, `emailInUse`, `wrongPassword`
  - –†—É—Å—Å–∫–∏–µ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **Result-–ø–∞—Ç—Ç–µ—Ä–Ω** (`AuthResult<T>`):
  - –Ø–≤–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ success/failure
  - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ **signOut() —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π**:
  - –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö `SharedPreferences` —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - Callback –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ Riverpod providers
  - Supabase signOut

### 3. Riverpod Provider (lib/providers/auth_provider.dart)
- ‚úÖ **AppAuthState** —Å 4 —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏:
  - `loading` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
  - `authenticated` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
  - `unauthenticated` ‚Äî –Ω–µ—Ç —Å–µ—Å—Å–∏–∏
  - `error` ‚Äî –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø—Ä–∏ signOut:
  - `profileProvider`
  - `statsProvider`
  - `muscleFatigueProvider`
- ‚úÖ **–°–ª—É—à–∞—Ç–µ–ª—å onAuthStateChange** ‚Äî —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 4. AuthWrapper (lib/widgets/auth_wrapper.dart)
- ‚úÖ **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞** –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- ‚úÖ **Loading screen** –ø–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–µ—Å—Å–∏—è
- ‚úÖ **–ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã** —á–µ—Ä–µ–∑ `AnimatedSwitcher`

### 5. main.dart
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AuthWrapper** –∫–∞–∫ `home:`
- ‚úÖ **–£–±—Ä–∞–Ω–∞ —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞** —Å `FutureBuilder`

## üìã –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å SQL –≤ Supabase
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `supabase_security_final.sql`
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ (Run)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å `rowsecurity = true`

### –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
flutter run

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
# 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# 2. –í–æ–π—Ç–∏ ‚Üí –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
# 3. –í—ã–π—Ç–∏ ‚Üí –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–∞—é—Ç—Å—è
# 4. –í–æ–π—Ç–∏ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Üí –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –ï–ì–û –¥–∞–Ω–Ω—ã–µ
```

## üîí –ì–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|-----------|
| –î–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ | ‚úÖ |
| –ù–µ–ª—å–∑—è –ø–æ–ª—É—á–∏—Ç—å —á—É–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API | ‚úÖ |
| –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | ‚úÖ |
| signOut –æ—á–∏—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à | ‚úÖ |
| Riverpod providers —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è | ‚úÖ |
| –ù–µ—Ç "–ø—Ä–∏–∑—Ä–∞—á–Ω—ã—Ö" –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞ | ‚úÖ |

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
lib/
‚îú‚îÄ‚îÄ main.dart                          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AuthWrapper
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ auth_service.dart              # –ü–ï–†–ï–ü–ò–°–ê–ù ‚Äî —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îî‚îÄ‚îÄ auth_provider.dart             # –ù–û–í–´–ô ‚Äî Riverpod auth state
‚îú‚îÄ‚îÄ widgets/
‚îÇ   ‚îî‚îÄ‚îÄ auth_wrapper.dart              # –ù–û–í–´–ô ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é
‚îî‚îÄ‚îÄ repositories/
    ‚îî‚îÄ‚îÄ user_repository.dart           # –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ‚Äî —É–∂–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ user_id

supabase_security_final.sql            # –ù–û–í–´–ô ‚Äî RLS + —Ç—Ä–∏–≥–≥–µ—Ä—ã
```

## ‚ö†Ô∏è –í–ê–ñ–ù–û

**–£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ç–µ–ø–µ—Ä—å –ù–ï–í–û–ó–ú–û–ñ–ù–ê** –Ω–∞ —É—Ä–æ–≤–Ω–µ:
1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äî RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ auth.uid()
2. **–ö–ª–∏–µ–Ω—Ç** ‚Äî –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `.eq('user_id', userId)`
3. **–ö—ç—à** ‚Äî SharedPreferences –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ signOut
4. **State** ‚Äî Riverpod providers –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
